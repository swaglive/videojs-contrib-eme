/*! @name videojs-contrib-eme @version 5.0.0 @license Apache-2.0 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("video.js")):"function"==typeof define&&define.amd?define(["exports","video.js"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).videojsContribEme={},e.videojs)}(this,(function(e,t){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=n(t);function i(){return i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},i.apply(this,arguments)}const r=(e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;const n=new DataView(e),s=new DataView(t);for(let e=0;e<n.byteLength;e++)if(n.getUint8(e)!==s.getUint8(e))return!1;return!0},a=e=>e instanceof Uint8Array||e instanceof Uint16Array?e.buffer:e,o=(...e)=>{const t=s.default.obj||s.default;return(t.merge||t.mergeOptions).apply(t,e)},d=(...e)=>{const t=o(...e);return Object.keys(t).forEach((e=>{null===t[e]&&delete t[e]})),t};let c=s.default.xhr.httpHandler;c||(c=(e,t)=>(n,s,i)=>{if(n)e(n);else{if(s.statusCode>=400&&s.statusCode<=599){let n=i;return t&&(n=String.fromCharCode.apply(null,new Uint8Array(i))),void e({cause:n})}e(null,i)}});const y=(e,t,n,i)=>{const r=(e=>{const t=String.fromCharCode.apply(null,new Uint16Array(e)),n=(new window.DOMParser).parseFromString(t,"application/xml"),s=n.getElementsByTagName("HttpHeaders")[0],i={};if(s){const e=s.getElementsByTagName("name"),t=s.getElementsByTagName("value");for(let n=0;n<e.length;n++)i[e[n].childNodes[0].nodeValue]=t[n].childNodes[0].nodeValue}const r=n.getElementsByTagName("Challenge")[0];let a;return r&&(a=window.atob(r.childNodes[0].nodeValue)),{headers:i,message:a}})(t),a=r.message,o=d(r.headers,n.emeHeaders,e.licenseHeaders);s.default.xhr({uri:e.url,method:"post",headers:o,body:a,responseType:"arraybuffer"},c(i,!0))},l="com.apple.fps.1_0",u=({initData:e,id:t,cert:n})=>{"string"==typeof t&&(t=(e=>{const t=new ArrayBuffer(2*e.length),n=new Uint16Array(t);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n})(t));let s=0;const i=new ArrayBuffer(e.byteLength+4+t.byteLength+4+n.byteLength),r=new DataView(i);new Uint8Array(i,s,e.byteLength).set(e),s+=e.byteLength,r.setUint32(s,t.byteLength,!0),s+=4;const a=new Uint16Array(i,s,t.length);a.set(t),s+=a.byteLength,r.setUint32(s,n.byteLength,!0),s+=4;return new Uint8Array(i,s,n.byteLength).set(n),new Uint8Array(i,0,i.byteLength)},g=e=>(t,n)=>{const i=d(t.emeHeaders,e.certificateHeaders);s.default.xhr({uri:e.certificateUri,responseType:"arraybuffer",headers:i},c(((e,t)=>{e?n(e):n(null,new Uint8Array(t))})))},m=(e,t)=>(e=>{const t=document.createElement("a");return t.href=e,t.hostname})(t),f=e=>(t,n,i,r)=>{const a=d({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);s.default.xhr({uri:e.licenseUri,method:"POST",responseType:"arraybuffer",body:i,headers:a},c(r,!0))},p=({video:e,initData:t,options:n,eventBus:s})=>{const i=n.keySystems[l],r=i.getCertificate||g(i),a=i.getContentId||m,o=i.getLicense||f(i);return new Promise(((e,t)=>{r(n,((n,s)=>{n?t(n):e(s)}))})).then((i=>{return(({video:e,contentId:t,initData:n,cert:s,options:i,getLicense:r,eventBus:a})=>new Promise(((o,d)=>{if(!e.webkitKeys)try{e.webkitSetMediaKeys(new window.WebKitMediaKeys(l))}catch(e){return void d("Could not create MediaKeys")}let c;try{c=e.webkitKeys.createSession("video/mp4",u({id:t,initData:n,cert:s}))}catch(e){return void d("Could not create key session")}a.trigger("keysessioncreated"),c.contentId=t,c.addEventListener("webkitkeymessage",(e=>{r(i,t,e.message,((e,t)=>{a&&a.trigger("licenserequestattempted"),e?d(e):c.update(new Uint8Array(t))}))})),c.addEventListener("webkitkeyadded",(()=>{o()})),c.addEventListener("webkitkeyerror",(()=>{const e=c.error;d(`KeySession error: code ${e.code}, systemCode ${e.systemCode}`)}))})))({video:e,cert:i,initData:t,getLicense:o,options:n,contentId:a(n,(r=t,String.fromCharCode.apply(null,new Uint16Array(r.buffer||r)))),eventBus:s});var r}))},h=e=>e.startsWith("com.apple.fps"),w=e=>{let t;return Object.keys(e).forEach((n=>{const s=((e,t)=>{if(t.supportedConfigurations)return t.supportedConfigurations;const n=h(e),s={},r=t.initDataTypes||(n?["sinf"]:null),a=t.audioContentType,o=t.audioRobustness,d=t.videoContentType||(n?"video/mp4":null),c=t.videoRobustness,y=t.persistentState;return(a||o)&&(s.audioCapabilities=[i({},a?{contentType:a}:{},o?{robustness:o}:{})]),(d||c)&&(s.videoCapabilities=[i({},d?{contentType:d}:{},c?{robustness:c}:{})]),y&&(s.persistentState=y),r&&(s.initDataTypes=r),[s]})(n,e[n]);t=t?t.catch((e=>window.navigator.requestMediaKeySystemAccess(n,s))):window.navigator.requestMediaKeySystemAccess(n,s)})),t},k=(e,t)=>{const{mediaKeys:n,initDataType:i,initData:r,options:a,getLicense:o,removeSession:d,addKeySession:c,eventBus:y,contentId:l}=t,u=n.createSession();return y.trigger("keysessioncreated"),e.on("dispose",(()=>{u.close()})),c(r,u),new Promise(((n,c)=>{const g=e=>{"license-request"!==e.messageType&&"license-renewal"!==e.messageType||o(a,e.message,l).then((e=>{n(u.update(e))})).catch((e=>{c(e)}))};u.addEventListener("message",g,!1),u.messageHandler=g;const m=n=>{let i=!1;u.keyStatuses.forEach(((e,t)=>{switch(y.trigger({keyId:t,status:e,target:u,type:"keystatuschange"}),e){case"expired":i=!0;break;case"internal-error":const e='Key status reported as "internal-error." Leaving the session open since we don\'t have enough details to know if this error is fatal.';s.default.log.warn(e,n)}})),i&&u.close().then((()=>{d(r),k(e,t)}))};u.addEventListener("keystatuseschange",m,!1),u.keyStatusesChangeHandler=m;const f=window.navigator&&window.navigator.userAgent&&window.navigator.userAgent.indexOf("Edge/")>-1?(e=>{if(null==e)return[];const t=new DataView(e.buffer||e),n={};let s,i=0;for(;;){const e=i;if(i>=t.buffer.byteLength)break;const r=i+t.getUint32(i);if(i+=4,1886614376!==t.getUint32(i)){i=r;continue}i+=4;const a=t.getUint8(i);if(0!==a&&1!==a){i=r;continue}let o,d;for(i++,i+=3,s="",o=0;o<4;o++)d=t.getUint8(i+o).toString(16),s+=1===d.length?"0"+d:d;for(i+=4,s+="-",o=0;o<2;o++)d=t.getUint8(i+o).toString(16),s+=1===d.length?"0"+d:d;for(i+=2,s+="-",o=0;o<2;o++)d=t.getUint8(i+o).toString(16),s+=1===d.length?"0"+d:d;for(i+=2,s+="-",o=0;o<2;o++)d=t.getUint8(i+o).toString(16),s+=1===d.length?"0"+d:d;for(i+=2,s+="-",o=0;o<6;o++)d=t.getUint8(i+o).toString(16),s+=1===d.length?"0"+d:d;i+=6,s=s.toLowerCase(),i+=4,n[s]=t.buffer.slice(e,r),i=r}return n[s]})(r):r;u.generateRequest(i,f).catch((()=>{c("Unable to create or initialize key session")}))}))},v=(e,t)=>{if("string"==typeof t&&(t={url:t}),!t.url&&t.licenseUri&&(t.url=t.licenseUri),!t.url&&!t.getLicense)throw new Error(`Missing url/licenseUri or getLicense in ${e} keySystem configuration.`);const n=h(e);if(n&&t.certificateUri&&!t.getCertificate&&(t.getCertificate=g(t)),n&&!t.getCertificate)throw new Error(`Missing getCertificate or certificateUri in ${e} keySystem configuration.`);return n&&!t.getContentId&&(t.getContentId=m),t.url&&!t.getLicense&&(t.getLicense="com.microsoft.playready"===e?(e=>(t,n,s)=>{y(e,n,t,s)})(t):n?f(t):(e=>(t,n,i)=>{const r=d({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);s.default.xhr({uri:e.url,method:"POST",responseType:"arraybuffer",body:n,headers:r},c(i,!0))})(t)),t},b=({player:e,video:t,initDataType:n,initData:s,keySystemAccess:i,options:r,removeSession:a,addKeySession:o,eventBus:d})=>{let c=Promise.resolve();const y=i.keySystem;let l;try{l=v(y,r.keySystems[y])}catch(e){return Promise.reject(e)}const u=l.getContentId?l.getContentId(r,(g=s,String.fromCharCode.apply(null,new Uint8Array(g.buffer||g)))):null;var g;if(void 0===t.mediaKeysObject){let n;t.mediaKeysObject=null,t.pendingSessionData=[],c=new Promise(((e,s)=>{t.keySystem=y,l.getCertificate?l.getCertificate(r,((t,i)=>{t?s(t):(n=i,e())})):e(i)})).then((()=>i.createMediaKeys())).then((s=>(({player:e,video:t,certificate:n,createdMediaKeys:s})=>{t.mediaKeysObject=s;const i=[];n&&i.push(s.setServerCertificate(n));for(let n=0;n<t.pendingSessionData.length;n++){const s=t.pendingSessionData[n];i.push(k(e,{mediaKeys:t.mediaKeysObject,initDataType:s.initDataType,initData:s.initData,options:s.options,getLicense:s.getLicense,removeSession:s.removeSession,eventBus:s.eventBus,contentId:s.contentId}))}return t.pendingSessionData=[],i.push(t.setMediaKeys(s)),Promise.all(i)})({player:e,video:t,certificate:n,createdMediaKeys:s}))).catch((e=>e?Promise.reject(e):Promise.reject("Failed to create and initialize a MediaKeys object")))}return c.then((()=>{const i=t.keySystem?((e,t,n,s)=>(i,r,a)=>new Promise(((o,d)=>{let c,y;try{c=n.vhs?n.vhs.playlists.masterXml_:"";const e=new RegExp(/<AdaptationSet(.*?ContentProtection.*?)<\/AdaptationSet>/,"gs"),t=c.match(e)||[],i=window.btoa(String.fromCharCode(...new Uint8Array(s))).slice(0,731)||"";y=t.reduce(((e,t,n,s)=>t.includes(i)?(s.splice(1),t&&t.match(/default_KID="(.+)"/)[1]):e),null)}catch(e){}const l=function(e,t){n&&n.trigger("licenserequestattempted"),e?d(e):o(t)};h(e)?t(i,a,new Uint8Array(r),l):t(i,r,l,y)})))(y,l.getLicense,d,s):null;return(({player:e,video:t,initDataType:n,initData:s,options:i,getLicense:r,contentId:a,removeSession:o,addKeySession:d,eventBus:c})=>{const y={initDataType:n,initData:s,options:i,getLicense:r,removeSession:o,addKeySession:d,eventBus:c,contentId:a};return t.mediaKeysObject?(y.mediaKeys=t.mediaKeysObject,k(e,y)):(t.pendingSessionData.push(y),Promise.resolve())})({player:e,video:t,initDataType:n,initData:s,options:r,getLicense:i,contentId:u,removeSession:a,addKeySession:o,eventBus:d})}))},S="com.microsoft.playready",K=(e,t,n,s)=>{const i=e.msKeys.createSession("video/mp4",t);if(!i)throw new Error("Could not create key session.");s.trigger("keysessioncreated"),i.addEventListener("mskeymessage",(e=>{((e,t,n,s)=>{let i=e.keySystems[S];if("function"==typeof i.getKey)return void i.getKey(e,n.destinationURL,n.message.buffer,((e,n)=>{e?s.trigger({message:"Unable to get key: "+e,target:t,type:"mskeyerror"}):t.update(n)}));"string"==typeof i?i={url:i}:"boolean"==typeof i&&(i={}),i.url||(i.url=n.destinationURL);const r=(e,n)=>{s&&s.trigger("licenserequestattempted"),e?s.trigger({message:"Unable to request key from url: "+i.url,target:t,type:"mskeyerror"}):t.update(new Uint8Array(n))};i.getLicense?i.getLicense(e,n.message.buffer,r):y(i,n.message.buffer,e,r)})(n,i,e,s)})),i.addEventListener("mskeyerror",(e=>{s.trigger({message:`Unexpected key error from key session with code: ${i.error.code} and systemCode: ${i.error.systemCode}`,target:i,type:"mskeyerror"})})),i.addEventListener("mskeyadded",(()=>{s.trigger({target:i,type:"mskeyadded"})}))};const D=(e,t,n)=>{for(let s=0;s<e.length;s++)if(e[s].initData===t)return void(e[s].keySession=n)},C=(e,t)=>{for(let n=0;n<e.length;n++){if(!e[n].initData)continue;const s=a(e[n].initData),i=a(t);if(r(s,i))return!0}return!1},L=(e,t)=>{for(let n=0;n<e.length;n++)if(e[n].initData===t)return void e.splice(n,1)},U=(e,t,n,s,i)=>{if(!n||!n.keySystems)return Promise.resolve();let r=t.initData;return w(n.keySystems).then((a=>{const o=a.keySystem;return n.keySystems[o]&&n.keySystems[o].pssh&&(r=n.keySystems[o].pssh),C(s,r)||!r?Promise.resolve():(s.push({initData:r}),b({player:e,video:t.target,initDataType:t.initDataType,initData:r,keySystemAccess:a,options:n,removeSession:L.bind(null,s),addKeySession:D.bind(null,s),eventBus:i}))}))},E=(e,t,n)=>t.keySystems&&t.keySystems[l]&&e.initData?p({video:e.target,initData:e.initData,options:t,eventBus:n}):Promise.resolve(),_=(e,t,n,s)=>{if(!t.keySystems||!t.keySystems[S])return;if(n.reduce(((e,t)=>e||t.playready),!1))return;let i=e.initData;t.keySystems[S]&&t.keySystems[S].pssh&&(i=t.keySystems[S].pssh),i&&(n.push({playready:!0,initData:i}),(({video:e,initData:t,options:n,eventBus:s})=>{e.msKeys&&delete e.msKeys;try{e.msSetMediaKeys(new window.MSMediaKeys(S))}catch(e){throw new Error("Unable to create media keys for PlayReady key system. Error: "+e.message)}K(e,t,n,s)})({video:e.target,initData:i,options:t,eventBus:s}))},T=e=>o(e.currentSource(),e.eme.options),A=e=>{const t=e.src();t!==e.eme.activeSrc&&(e.eme.activeSrc=t,e.eme.sessions=[])},M=e=>t=>{const n={code:5};"string"==typeof t?n.message=t:t&&(t.message&&(n.message=t.message),t.cause&&(t.cause.length||t.cause.byteLength)&&(n.cause=t.cause)),e.error(n)},j=function(e={}){const t=this,n=M(t);t.ready((()=>((e,t)=>{if("video"===e.$(".vjs-tech").tagName.toLowerCase())if(A(e),window.MediaKeys&&!window.WebKitMediaKeys)e.tech_.el_.addEventListener("encrypted",(n=>{A(e),U(e,n,T(e),e.eme.sessions,e.tech_).catch(t)}));else if(window.WebKitMediaKeys){const n=n=>{A(e),E(n,T(e),e.tech_).catch(t)};e.tech_.el_.addEventListener("webkitneedkey",(t=>{const s=T(e).firstWebkitneedkeyTimeout||1e3,i=e.src();e.eme.webkitneedkey_=e.eme.webkitneedkey_||{},e.eme.webkitneedkey_.src!==i&&(e.eme.webkitneedkey_={handledFirstEvent:!1,src:i}),e.eme.webkitneedkey_.handledFirstEvent?n(t):(e.clearTimeout(e.eme.webkitneedkey_.timeout),e.eme.webkitneedkey_.timeout=e.setTimeout((()=>{e.eme.webkitneedkey_.handledFirstEvent=!0,e.eme.webkitneedkey_.timeout=null,n(t)}),s))}))}else window.MSMediaKeys&&(e.tech_.el_.addEventListener("msneedkey",(n=>{A(e);try{_(n,T(e),e.eme.sessions,e.tech_)}catch(e){t(e)}})),e.tech_.on("mskeyerror",t),e.on("dispose",(()=>{e.tech_.off("mskeyerror",t)})))})(t,n))),t.eme={initializeMediaKeys(s={},i=function(){},r=!1){const a=o(t.currentSource(),e,s),d={initDataType:"cenc",initData:null,target:t.tech_.el_};if(A(t),window.MediaKeys)U(t,d,a,t.eme.sessions,t.tech_).then((()=>i())).catch((e=>{i(e),r||n(e)}));else if(window.MSMediaKeys){const e=s=>{t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),"mskeyerror"===s.type?(i(s.target.error),r||n(s.message)):i()};t.tech_.one("mskeyadded",e),t.tech_.one("mskeyerror",e);try{_(d,a,t.eme.sessions,t.tech_)}catch(s){t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),i(s),r||n(s)}}},options:e}};s.default.registerPlugin("eme",j),j.VERSION="5.0.0",e.addKeySession=D,e.closeKeySession=(e=[])=>{for(let t=0;t<e.length;t++)e[t].keySession&&e[t].keySession.close()},e.default=j,e.emeErrorHandler=M,e.getOptions=T,e.handleEncryptedEvent=U,e.handleMsNeedKeyEvent=_,e.handleWebKitNeedKeyEvent=E,e.hasSession=C,e.removeSession=L,e.setupSessions=A,Object.defineProperty(e,"__esModule",{value:!0})}));
